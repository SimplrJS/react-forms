<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for lib\DocItemLoader.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">lib/</a> DocItemLoader.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">74.03% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>57/77</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">57.89% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>22/38</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">87.5% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>7/8</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">74.03% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>57/77</span>
      </div>
    </div>
  </div>
  <div class='status-line medium'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">27×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">33×</span>
<span class="cline-any cline-yes">33×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">30×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">26×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">26×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">26×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">33×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">33×</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">33×</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">"use strict";
// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.
// See LICENSE in the project root for license information.
Object.defineProperty(exports, "__esModule", { value: true });
var fsx = require("fs-extra");
var os = require("os");
var path = require("path");
var ApiItemContainer_1 = require("./definitions/ApiItemContainer");
var ResolvedApiItem_1 = require("./ResolvedApiItem");
var JsonFile_1 = require("./JsonFile");
/**
 * A loader for locating the IDocItem associated with a given project and API item, or
 * for locating an ApiItem  locally.
 * No processing on the IDocItem orApiItem  should be done in this class, this class is only
 * concerned with communicating state.
 * The IDocItem can then be used to enforce correct API usage, like enforcing internal.
 * To use DocItemLoader: provide a projectFolder to construct a instance of the DocItemLoader,
 * then use DocItemLoader.getItem to retrieve the IDocItem of a particular API item.
 */
var DocItemLoader = (function () {
    /**
     * The projectFolder is the top-level folder containing package.json for a project
     * that we are compiling.
     */
    function DocItemLoader(projectFolder) {
        <span class="missing-if-branch" title="if path not taken" >I</span>if (!fsx.existsSync(path.join(projectFolder, 'package.json'))) {
<span class="cstat-no" title="statement not covered" >            throw new Error("An NPM project was not found in the specified folder: " + projectFolder);</span>
        }
        this._projectFolder = projectFolder;
        this._cache = new Map();
    }
    /**
     * {@inheritdoc IReferenceResolver.resolve}
     */
    DocItemLoader.prototype.resolve = function (apiDefinitionRef, apiPackage, warnings) {
        // We determine if an 'apiDfefinitionRef' is local if it has no package name or if the scoped
        // package name is equal to the current package's scoped package name.
        if (!apiDefinitionRef.packageName || apiDefinitionRef.toScopePackageString() === apiPackage.name) {
            // Resolution for local references
            return this.resolveLocalReferences(apiDefinitionRef, apiPackage, warnings);
        }
        else {
            // If there was no resolved apiItem then try loading from JSON
            return this.resolveJsonReferences(apiDefinitionRef, warnings);
        }
    };
    /**
     * Resolution of API definition references in the scenario that the reference given indicates
     * that we should search within the current ApiPackage to resolve.
     * No processing on the ApiItem should be done here, this class is only concerned
     * with communicating state.
     */
    DocItemLoader.prototype.resolveLocalReferences = function (apiDefinitionRef, apiPackage, warnings) {
        var apiItem = apiPackage.getMemberItem(apiDefinitionRef.exportName);
        // Check if export name was not found
        <span class="missing-if-branch" title="if path not taken" >I</span>if (!apiItem) {
<span class="cstat-no" title="statement not covered" >            warnings.push("Unable to find referenced export \"" + apiDefinitionRef.toExportString() + "\"");</span>
<span class="cstat-no" title="statement not covered" >            return undefined;</span>
        }
        // If memberName exists then check for the existense of the name
        if (apiDefinitionRef.memberName) {
            <span class="missing-if-branch" title="else path not taken" >E</span>if (apiItem instanceof ApiItemContainer_1.default) {
                var apiItemContainer = apiItem;
                // get() returns undefined if there is no match
                apiItem = apiItemContainer.getMemberItem(apiDefinitionRef.memberName);
            }
            else {
                // There are no other instances of apiItem that has members,
                // thus there must be a mistake with the apiDefinitionRef.
<span class="cstat-no" title="statement not covered" >                apiItem = undefined;</span>
            }
        }
        if (!apiItem) {
            // If we are here, we can be sure there was a problem with the memberName.
            // memberName was not found, apiDefinitionRef is invalid
            warnings.push("Unable to find referenced member \"" + apiDefinitionRef.toMemberString() + "\"");
            return undefined;
        }
        return ResolvedApiItem_1.default.createFromApiItem(apiItem);
    };
    /**
     * Resolution of API definition references in the scenario that the reference given indicates
     * that we should search outside of this ApiPackage and instead search within the JSON API file
     * that is associated with the apiDefinitionRef.
     */
    DocItemLoader.prototype.resolveJsonReferences = function (apiDefinitionRef, warnings) {
        // Check if package can be not found
        var docPackage = this.getPackage(apiDefinitionRef);
        if (!docPackage) {
            // package not found in node_modules
            warnings.push("Unable to find a documentation file (\"" + apiDefinitionRef.packageName + ".api.json\")" +
                ' for the referenced package');
            return undefined;
        }
        // found JSON package, now ensure export name is there
        // hasOwnProperty() not needed for JJU objects
        if (!(apiDefinitionRef.exportName in docPackage.exports)) {
            warnings.push("Unable to find referenced export \"" + apiDefinitionRef.toExportString() + "\"\"");
            return undefined;
        }
        var docItem = docPackage.exports[apiDefinitionRef.exportName];
        // If memberName exists then check for the existense of the name
        <span class="missing-if-branch" title="if path not taken" >I</span>if (apiDefinitionRef.memberName) {
<span class="cstat-no" title="statement not covered" >            var member = undefined;</span>
<span class="cstat-no" title="statement not covered" >            switch (docItem.kind) {</span>
                case 'class':
                    // hasOwnProperty() not needed for JJU objects
<span class="cstat-no" title="statement not covered" >                    member = apiDefinitionRef.memberName in docItem.members ?</span>
                        docItem.members[apiDefinitionRef.memberName] : undefined;
<span class="cstat-no" title="statement not covered" >                    break;</span>
                case 'interface':
                    // hasOwnProperty() not needed for JJU objects
<span class="cstat-no" title="statement not covered" >                    member = apiDefinitionRef.memberName in docItem.members ?</span>
                        docItem.members[apiDefinitionRef.memberName] : undefined;
<span class="cstat-no" title="statement not covered" >                    break;</span>
                case 'enum':
                    // hasOwnProperty() not needed for JJU objects
<span class="cstat-no" title="statement not covered" >                    member = apiDefinitionRef.memberName in docItem.values ?</span>
                        docItem.values[apiDefinitionRef.memberName] : undefined;
<span class="cstat-no" title="statement not covered" >                    break;</span>
                default:
                    // Any other docItem.kind does not have a 'members' property
<span class="cstat-no" title="statement not covered" >                    break;</span>
            }
<span class="cstat-no" title="statement not covered" >            if (member) {</span>
<span class="cstat-no" title="statement not covered" >                docItem = member;</span>
            }
            else {
                // member name was not found, apiDefinitionRef is invalid
<span class="cstat-no" title="statement not covered" >                warnings.push("Unable to find referenced member \"" + apiDefinitionRef.toMemberString() + "\"");</span>
<span class="cstat-no" title="statement not covered" >                return undefined;</span>
            }
        }
        return ResolvedApiItem_1.default.createFromJson(docItem);
    };
    /**
     * Attempts to locate and load the IDocPackage object from the project folder's
     * node modules. If the package already exists in the cache, nothing is done.
     *
     * @param apiDefinitionRef - interface with propropties pertaining to the API definition reference
     */
    DocItemLoader.prototype.getPackage = function (apiDefinitionRef) {
        var cachePackageName = '';
        // We concatenate the scopeName and packageName in case there are packageName conflicts
        if (apiDefinitionRef.scopeName) {
            cachePackageName = apiDefinitionRef.scopeName + "/" + apiDefinitionRef.packageName;
        }
        else {
            cachePackageName = apiDefinitionRef.packageName;
        }
        // Check if package exists in cache
        if (this._cache.has(cachePackageName)) {
            return this._cache.get(cachePackageName);
        }
        // Doesn't exist in cache, attempt to load the json file
        var apiJsonFilePath = path.join(this._projectFolder, 'node_modules', apiDefinitionRef.scopeName, apiDefinitionRef.packageName, "dist/" + apiDefinitionRef.packageName + ".api.json");
        if (!fsx.existsSync(path.join(apiJsonFilePath))) {
            // Error should be handled by the caller
            return undefined;
        }
        return this.loadPackageIntoCache(apiJsonFilePath, cachePackageName);
    };
    /**
     * Loads the API documentation json file and validates that it conforms to our schema. If it does,
     * then the json file is saved in the cache and returned.
     */
    DocItemLoader.prototype.loadPackageIntoCache = function (apiJsonFilePath, cachePackageName) {
        var apiPackage = JsonFile_1.default.loadJsonFile(apiJsonFilePath);
        // Validate that the output conforms to our JSON schema
        var apiJsonSchema = JsonFile_1.default.loadJsonFile(path.join(__dirname, './schemas/api-json-schema.json'));
        JsonFile_1.default.validateSchema(apiPackage, apiJsonSchema, <span class="fstat-no" title="function not covered" >function (errorDetail) {</span>
<span class="cstat-no" title="statement not covered" >            var errorMessage = "ApiJsonGenerator validation error - output does not conform to api-json-schema.json:" + os.EOL</span>
                + errorDetail;
<span class="cstat-no" title="statement not covered" >            console.log(os.EOL + 'ERROR: ' + errorMessage + os.EOL + os.EOL);</span>
<span class="cstat-no" title="statement not covered" >            throw new Error(errorMessage);</span>
        });
        this._cache.set(cachePackageName, apiPackage);
        return apiPackage;
    };
    return DocItemLoader;
}());
exports.default = DocItemLoader;
&nbsp;
//# sourceMappingURL=DocItemLoader.js.map
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Mon Jul 17 2017 10:37:19 GMT+0300 (FLE Daylight Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
